<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mediciones de Temperatura</title>
    <link href="/estilos.css" rel="stylesheet">
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/data.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 0;
        }

        header {
            background-color: #007bff;
            padding: 20px;
            text-align: center;
            color: #fff;
        }

        header h1 {
            margin: 0;
        }

        header a {
            color: #fff;
            text-decoration: none;
            font-weight: bold;
            background-color: #ff6347;
            padding: 10px 20px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        header a:hover {
            background-color: #ff4500;
        }

        #container {
            margin: 40px auto;
            width: 80%;
        }

        .highcharts-description {
            text-align: center;
            font-size: 1.1rem;
            color: #666;
            margin: 20px 0;
        }

        footer {
            background-color: #007bff;
            padding: 10px;
            text-align: center;
            color: #fff;
            position: fixed;
            width: 100%;
            bottom: 0;
        }
    </style>
</head>
<body>
    <header>
        <h1>Bienvenido, <%= usuario %></h1>
        <a href="/logout">Cerrar sesión</a>
    </header>

    <div id="container"></div>
    <p class="highcharts-description">Gráfica de la temperatura de la termocupla y el PT100.</p>

    <script>
        Highcharts.chart('container', {
            chart: {
                type: 'areaspline'
            },
            title: {
                text: 'Termocupla vs PT100'
            },tooltip: {
                    formatter: function () {
                        var date = new Date(this.x);
                        return `<b>${this.series.name}</b><br/>${date.toLocaleDateString()} ${date.toLocaleTimeString()}<br/>${this.y}°C`;
                    }
                },
            series: [{
                name: 'Serie',
                data: []
            }, {
                name: 'Temperatura',
                data: []
            }],
            xAxis: {
                type: 'datetime',
                title: { text: 'Tiempo' },
                labels: { format: '{value:%Y-%m-%d %H:%M:%S}' },
                tickInterval: 1000 * 60 * 60
            },
            yAxis: {
                title: { text: 'Temperatura (°C)' },
                max: 250,
                labels: { formatter: function() { return this.value + '°C'; } }
            }
        });
        
        function updateChart() {
            fetch('/data')
                .then(response => response.json())
                .then(data => {
                    const chart = Highcharts.charts[0];
                    const serieData = data.map(item => [Date.parse(item.Fecha), parseFloat(item.Serie)]);
                    const temperaturaData = data.map(item => [Date.parse(item.Fecha), parseFloat(item.Temperatura)]);

                    chart.series[0].setData(serieData);
                    chart.series[1].setData(temperaturaData);
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        setInterval(updateChart, 5000);
        updateChart();
    </script>
        <section>
            <h2>Gráfico de Termocupla</h2>
            <div id="termocuplaChart"></div>
        </section>
    
        <section>
            <h2>Gráfico de PT100</h2>
            <div id="pt100Chart"></div>
        </section>
        <script type="text/javascript">
            const defaultData = 'api.php';
    
            function createChart(container, series) {
                Highcharts.chart(container, {
                    chart: { type: 'areaspline' },
                    title: { text: series.title },
                    xAxis: { type: 'datetime', title: { text: 'Tiempo' } },
                    yAxis: { title: { text: 'Temperatura (°C)' } },
                    tooltip: {
                        formatter: function () {
                            var date = new Date(this.x);
                            return `<b>${this.series.name}</b><br/>${date.toLocaleDateString()} ${date.toLocaleTimeString()}<br/>${this.y}°C`;
                        }
                    },
                    series: [series],
                    plotOptions: {
                        areaspline: {
                            marker: { lineWidth: 1, lineColor: null, fillColor: 'white' },
                            fillColor: {
                                linearGradient: { x1: 0, x2: 0, y1: 0, y2: 1 },
                                stops: [
                                    [0, series.fillStartColor],
                                    [1, series.fillEndColor]
                                ]
                            }
                        }
                    }
                });
            }
    
            function fetchDataAndUpdateCharts() {
                fetch(defaultData)
                    .then(response => response.json())
                    .then(data => {
                        const serieData = data.map(item => [Date.parse(item.Fecha), parseFloat(item.Serie)]);
                        const temperaturaData = data.map(item => [Date.parse(item.Fecha), parseFloat(item.Temperatura)]);
                        
    
                        // Gráfico individual Termocupla
                        createChart('termocuplaChart', {
                            title: 'Gráfico de Termocupla',
                            name: 'Termocupla',
                            data: serieData.slice(-10),
                            color: 'rgba(95, 218, 147, 1)',
                            fillStartColor: 'rgba(95, 218, 147, 0.2)',
                            fillEndColor: 'rgba(95, 218, 147, 0)'
                        });
    
                        // Gráfico individual PT100
                        createChart('pt100Chart', {
                            title: 'Gráfico de PT100',
                            name: 'PT100',
                            data: temperaturaData.slice(-10),
                            color: 'rgba(255, 87, 51, 1)',
                            fillStartColor: 'rgba(255, 87, 51, 0.2)',
                            fillEndColor: 'rgba(255, 87, 51, 0)'
                        });
                    })
                    .catch(error => console.error('Error fetching data:', error));
            }
    
            setInterval(fetchDataAndUpdateCharts, 5000);
            fetchDataAndUpdateCharts();
        </script>
    <footer>
        <p>Temperatubies© 2024 | <a href="#">Términos y condiciones</a></p>
    </footer>
</body>
</html>
